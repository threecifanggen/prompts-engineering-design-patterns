---
description: "Cursor 上下文管理和最佳实践规则，涵盖语义搜索、规则、命令、技能、子代理等核心功能的使用指南"
alwaysApply: false
---

# Cursor 上下文管理规则

这个规则提供了 Cursor IDE 中上下文管理的全面指南，帮助 Agent 更有效地使用各种上下文功能。

## 核心上下文功能

### 1. 语义搜索 (Semantic Search)

#### 工作原理
- 代码被分块并转换为向量表示（embeddings）
- 自动同步工作区文件到 Cursor 服务器
- 使用 AI 模型理解代码的语义含义
- 可以通过自然语言提问找到相关代码

#### 使用场景
- 探索不熟悉的代码库
- 查找在概念上相似的代码（如 "header" 和 "top navigation" 的语义关联）
- 需要快速定位功能实现位置

#### 最佳实践
- 当进度达到 80% 时语义搜索即可使用
- 与 grep 配合使用：grep 适合精确模式匹配，语义搜索适合概念级匹配
- 大型/复杂文件可能被跳过以提高性能
- 使用 `.cursorignore` 排除不相关内容以提升准确性

#### 索引管理
- 每 5 分钟自动同步一次
- 新文件自动加入索引
- 修改过的文件会删除旧向量并重新生成
- 已删除的文件立即从索引中移除

### 2. 规则 (Rules)

#### 规则类型
1. **项目规则** (Project Rules)
   - 存放在 `.cursor/rules/` 目录
   - 受版本控制，团队共享
   - 支持路径模式限定作用范围

2. **用户规则** (User Rules)
   - 全局生效，在所有项目中使用
   - 适合个人编码风格和首选项

3. **团队规则** (Team Rules)
   - 在 Cursor 控制台集中管理
   - 适用于 Team 和 Enterprise 方案
   - 可设为强制执行

4. **AGENTS.md**
   - 简洁的 Markdown 格式
   - 适合简单直接的用例
   - 放在项目根目录

#### 规则应用类型
- **Always Apply**: 应用于每个聊天会话（`alwaysApply: true`）
- **Apply Intelligently**: Agent 根据描述判断是否相关
- **Apply to Specific Files**: 匹配指定 glob 模式
- **Apply Manually**: 通过 @ 提及手动应用（如 `@my-rule`）

#### 规则文件格式
```markdown
---
description: "规则描述和使用场景"
alwaysApply: false
globs: ["src/**/*.ts"]
---

规则内容...
```

#### 最佳实践
- 将规则控制在 500 行以内
- 将大型规则拆分为多个可组合的规则
- 提供具体示例或参考文件
- 通过引用文件而不是复制内容
- 避免逐条记录所有可能的命令
- 只在 Agent 反复犯同一个错误时才添加规则
- 将规则提交到 git，整个团队受益

#### 避免的内容
- 整篇照搬风格指南（改用 linter）
- 逐条记录所有可能的命令
- 为极少出现的边缘情况添加说明
- 重复代码库中已有的内容

#### 规则优先级
Team Rules → Project Rules → User Rules

### 3. 命令 (Commands)

#### 命令存放位置
1. **项目命令**: `.cursor/commands/`
2. **全局命令**: `~/.cursor/commands/`
3. **团队命令**: 在 Cursor Dashboard 中创建

#### 使用方式
- 在聊天输入框中输入 `/` 触发
- 命令后可以提供额外参数和上下文
- 示例: `/commit and /pr these changes to address DX-523`

#### 命令文件结构
```
.cursor/
└── commands/
    ├── review-code.md
    ├── write-tests.md
    ├── create-pr.md
    └── security-audit.md
```

#### 最佳实践
- 使用描述性文件名
- 用纯 Markdown 编写
- 标准化团队流程
- 提高常见任务的执行效率

### 4. 技能 (Agent Skills)

#### 什么是技能
- 用于扩展 AI Agent 专门能力的开放标准
- 可移植、支持版本控制
- 可包含说明性指令和可执行脚本
- 按需加载资源，提高上下文效率

#### 技能目录结构
```
.cursor/
└── skills/
    └── my-skill/
        ├── SKILL.md          # 必需
        ├── scripts/          # 可选
        ├── references/       # 可选
        └── assets/           # 可选
```

#### SKILL.md 格式
```markdown
---
name: my-skill
description: 简要描述此技能的功能及使用时机
disable-model-invocation: false  # true 时仅手动调用
---

# 技能名称

详细指令...

## 使用时机
- 在以下情况使用...

## 指令
- 分步指导
- 最佳实践
```

#### Frontmatter 字段
- `name`: 技能标识符（必填）
- `description`: 描述作用和使用场景（必填）
- `license`: 许可证信息
- `compatibility`: 运行环境要求
- `disable-model-invocation`: 是否禁用自动调用

#### 技能 vs 命令
- **技能**: 多步骤、需要上下文、可包含脚本
- **命令**: 单一用途、快速可重复操作

#### 从 GitHub 安装技能
1. 打开 Cursor Settings → Rules
2. 点击 Add Rule → Remote Rule (Github)
3. 输入 GitHub 仓库 URL

#### 迁移到技能
使用 `/migrate-to-skills` 命令迁移：
- 动态规则（Apply Intelligently）
- 斜杠命令（保留显式调用行为）

### 5. 子代理 (Subagents)

#### 什么是子代理
- 专业化的 AI 助手
- 在独立上下文窗口中运行
- 可以并行执行
- 处理特定类型的工作

#### 子代理优势
- **上下文隔离**: 不占用主对话的上下文
- **并行执行**: 同时启动多个子代理
- **专门领域能力**: 自定义提示词和工具
- **可复用**: 在多个项目之间复用

#### 内置子代理
1. **Explore**: 搜索并分析代码库
2. **Bash**: 运行一系列 Shell 命令
3. **Browser**: 通过 MCP 工具控制浏览器

#### 运行模式
- **前台**: 阻塞直到完成，立即返回结果
- **后台**: 立即返回，独立运行

#### 子代理文件位置
- 项目: `.cursor/agents/`, `.claude/agents/`, `.codex/agents/`
- 用户: `~/.cursor/agents/`, `~/.claude/agents/`, `~/.codex/agents/`

#### 子代理文件格式
```markdown
---
name: security-auditor
description: 安全专家。用于实现身份验证、支付或处理敏感数据时。
model: inherit  # fast, inherit, 或具体模型 ID
readonly: false
is_background: false
---

你是一位代码安全审计专家...

## 调用时
1. 识别安全敏感代码路径
2. 检查常见漏洞
3. 验证密钥未被硬编码
4. 审查输入验证
```

#### 使用方式
- **自动委派**: Agent 根据任务复杂度自动委派
- **显式调用**: 使用 `/name` 语法或自然语言提及
- **并行执行**: 同时启动多个子代理
- **恢复子代理**: 使用 agent ID 恢复之前的会话

#### 常见模式
1. **验证代理**: 验证已完成的工作
2. **协调器模式**: Planner → Implementer → Verifier
3. **调试器**: 专注于根因分析
4. **测试运行工具**: 主动运行测试并修复失败

#### 最佳实践
- 编写职责单一的子代理
- 投入精力写好描述
- 保持提示简洁
- 将子代理纳入版本控制
- 使用 hooks 进行文件输出

#### 避免的反模式
- 创建几十个泛泛的子代理
- 描述过于模糊
- 提示词过于冗长
- 重复 slash 命令的功能
- 子代理过多（先从 2-3 个开始）

#### 性能与成本
- 每个子代理独立消耗 token
- 适合复杂、长时间运行或并行工作
- 简单任务使用主 agent 可能更快

#### 何时使用子代理 vs 技能
- **子代理**: 需要上下文隔离、并行运行、多步骤专业知识、独立校验
- **技能**: 单一用途、快速可重复、一次性完成、不需要独立上下文

### 6. @ 提及 (@ Mentions)

#### @Files & Folders
- 引用整个文件或文件夹
- 可将侧边栏文件拖入 Agent
- 大型文件和文件夹会自动精简
- 选中文件夹后输入 `/` 进入下一级

#### @Code
- 引用特定代码片段
- 比 @Files 更细粒度的控制
- 可选择精确的代码片段

#### @Docs
- 利用文档帮助编写代码
- Cursor 内置常用文档资源
- 可添加自定义文档站点
- 支持团队共享文档

#### 添加自定义文档
1. 输入 `@Docs` → Add new doc
2. 粘贴文档站点 URL
3. Cursor 自动读取并理解文档
4. 启用 "Share with team" 共享

#### 内置命令
- **Summarize**: 压缩上下文窗口并总结对话

### 7. 忽略文件 (Ignore Files)

#### 忽略文件类型

1. **`.cursorignore`**
   - 完全阻止 Cursor 访问
   - 影响语义搜索、Tab、Agent、@ 提及
   - 不影响终端和 MCP server 工具

2. **`.cursorindexingignore`**
   - 只在索引时排除
   - AI 功能仍可访问
   - 不出现在代码库搜索结果中

3. **全局忽略**
   - 在用户设置中配置
   - 应用于所有项目
   - 默认包含 .env、credentials.json、*.key 等

#### 为什么要忽略文件
- **安全性**: 限制对敏感信息的访问
- **性能**: 加快索引速度，提高准确性

#### 模式示例
```
config.json       # 特定文件
dist/             # 目录
*.log             # 文件扩展名
**/logs           # 嵌套目录
!app/             # 排除忽略（取反）
```

#### 默认忽略
- Cursor 自动忽略 `.gitignore` 中的文件
- 可用 `!` 前缀覆盖

#### 否定模式限制
- 无法重新包含通过 `*` 排除的父目录中的文件
- 变通方案: 显式排除嵌套目录

#### 分层忽略
- 启用 `Hierarchical Cursor Ignore`
- 在父目录中搜索 `.cursorignore` 文件

## 上下文管理最佳实践

### 整体策略
1. **渐进式添加**: 先从简单开始，只在需要时添加
2. **团队协作**: 将配置提交到版本控制
3. **定期审查**: 更新规则以反映最新实践
4. **测试验证**: 确保配置按预期工作
5. **文档记录**: 为自定义配置添加说明

### 性能优化
1. 使用 `.cursorignore` 排除大型无关文件
2. 将规则控制在合理大小
3. 优先使用语义搜索而非手动搜索
4. 合理使用子代理进行并行工作
5. 按需加载技能资源

### 安全考虑
1. 始终忽略敏感文件（.env、credentials 等）
2. 使用全局忽略列表作为基础防护
3. 定期审查索引的文件
4. 注意团队规则的访问权限
5. 不要将密钥硬编码在配置中

### 团队协作
1. 将项目规则、命令、技能提交到 git
2. 使用团队规则强制执行标准
3. 共享有用的文档资源
4. 统一命名和组织规范
5. 定期同步团队配置

## 故障排查

### 语义搜索问题
- 检查网络连接
- 核实工作区权限
- 重启 Cursor
- 查看已索引的文件列表

### 规则未生效
- 检查 frontmatter 格式
- 验证 glob 模式匹配
- 确认 `alwaysApply` 设置
- 查看规则优先级

### 子代理问题
- 检查 description 是否清晰
- 验证 name 字段正确
- 确认文件位置正确
- 查看子代理执行日志

### 忽略文件问题
- 使用 `git check-ignore -v [file]` 测试
- 检查模式语法
- 验证分层忽略设置
- 注意否定模式的限制

## 参考资源

### 官方文档
- https://cursor.com/cn/docs/context/semantic-search
- https://cursor.com/cn/docs/context/rules
- https://cursor.com/cn/docs/context/commands
- https://cursor.com/cn/docs/context/skills
- https://cursor.com/cn/docs/context/subagents
- https://cursor.com/cn/docs/context/mentions
- https://cursor.com/cn/docs/context/ignore-files

### Agent Skills 标准
- https://agentskills.io

### 相关设置
- Cursor Settings → Rules, Commands
- Cursor Settings → Indexing & Docs
- Cursor Settings → Features → Editor

## 总结

Cursor 提供了丰富的上下文管理功能，合理使用这些功能可以：
- 提高 AI 辅助编码的准确性和效率
- 标准化团队工作流程
- 保护敏感信息安全
- 优化代码库索引性能
- 实现复杂任务的自动化

关键是根据实际需求选择合适的工具，保持配置简洁有效，并与团队保持同步。
